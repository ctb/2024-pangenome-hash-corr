# run all the scripts, as a basic test!
SCALED=1000

rule assoc:
    input:
        "agatha-genomes.10k.all.cmp.matrix.png",
        "agatha-genomes.10k.all.cmp.matrix.pdf",
        expand("agatha-genomes.10k.{p}.cmp.matrix.png",
               p=('shell', 'cloud', 'core')),
        expand("agatha-genomes.10k.{p}.cmp.matrix.pdf",
               p=('shell', 'cloud', 'core')),
        "agatha-genomes.10k.presence.csv",
        "agatha-genomes.10k.presence.png",

rule calc_genome_presence:
    input:
        ranktable_csv = "ranktable.agathobacter_faecis.csv",
        db = "gtdb-rs214-agatha-k21.zip"
    output: "agatha-genomes.10k.dump"
    shell: """
        ./calc-hash-presence.py {input.ranktable_csv} {input.db} -o {output} --scaled={SCALED}
    """

rule make_assoc_matrix_genomes_all:
    input:
        "agatha-genomes.10k.dump",
    output:
        "agatha-genomes.10k.all.cmp",
    shell: """
        ./calc-hash-assoc.py {input} -o {output} --scaled=10000 --min=2
    """

rule make_assoc_matrix_genomes_core:
    input:
        "agatha-genomes.10k.dump",
    output:
        "agatha-genomes.10k.core.cmp",
    shell: """
        ./calc-hash-assoc.py {input} -o {output} --scaled=10000 --min=2 --pangenome 12
    """

rule make_assoc_matrix_genomes_shell:
    input:
        "agatha-genomes.10k.dump",
    output:
        "agatha-genomes.10k.shell.cmp",
    shell: """
        ./calc-hash-assoc.py {input} -o {output} --scaled=10000 --min=2 --pangenome 3
    """

rule make_assoc_matrix_genomes_cloud:
    input:
        "agatha-genomes.10k.dump",
    output:
        cmp="agatha-genomes.10k.cloud.cmp",
        csv="agatha-genomes.10k.cloud.cmp.csv",
        cat_csv="agatha-genomes.10k.cloud.cmp.categories.csv",
    shell: """
        ./calc-hash-assoc.py {input} -o {output.cmp} --scaled=10000 --min=2 --pangenome 12345 --categories {output.cat_csv} --compare-csv {output.csv}
    """

rule plot_hash_presence:
    input:
        dump="agatha-genomes.10k.dump",
    output:
        presence="agatha-genomes.10k.presence.csv",
        cat="agatha-genomes.10k.presence.categories.csv",
    shell: """
        ./plot-hash-presence.py {input} -o {output.presence} \
            --categories-csv {output.cat}
    """

rule plot_hash_presence_make_png:
    input:
        presence="agatha-genomes.10k.presence.csv",
        cat="agatha-genomes.10k.presence.categories.csv",
    output:
        "agatha-genomes.10k.presence.png"
    shell: """
        sourmash scripts clustermap1 {input.presence} -u presence \
            -C {input.cat} -o {output}
    """

rule make_png_plot:
    input: "{cmp}"
    output: "{cmp}.matrix.png"
    shell: "sourmash plot {input}"

rule make_pdf_plot:
    input: "{cmp}"
    output: "{cmp}.matrix.pdf"
    shell: "sourmash plot {input} --pdf"
